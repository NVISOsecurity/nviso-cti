# Summary

On May 27th a Maldoc was [discovered](https://twitter.com/nao_sec/status/1530196847679401984) which loads HTML content. In the HTML a script is defined that leverages the "ms-msdt" scheme to achieve code execution on a system. 

The "ms-msdt" scheme is part of the Microsoft Office URI schemes which instructs the Microsoft operating system to open a URI with a specific executable. As an example, the URI `ms-excel:ofv|u|https://contoso/Q4/budget.xls` would start the application that is linked to the ms-excel scheme, in most cases that would be Microsoft Excel.

For basic information on the MS Office URI Schemes: https://docs.microsoft.com/en-us/office/client-developer/office-uri-schemes

A larger list of supported schemes has been identfied by [SySS](https://blog.syss.com/posts/abusing-ms-office-protos/) which contained among others also the `ms-msdt` scheme. As it appears now the `ms-msdt` scheme can be leveraged to achieve code execution.

# Why this matters

The abuse of the `ms-msdt` scheme reaches further than just the creation of Maldocs. Any application supporting the MS Protocols could be a potential payload carrier. MS Outlook and .lnk files have already been [identified](https://twitter.com/GossiTheDog/status/1530905874675408897) as attack vectors. 

The technique doesn't require any user interaction, as soon as the malicious carrier (email, .lnk, office document ...) is opened, code execution will be achieved.

As of writing, the initial Maldoc was only identified by 6 different AV vendors on VirusTotal: 

![VirusTotal](/advisories/images/msdt-vt.PNG?raw=true)

[VirusTotal](https://www.virustotal.com/gui/file/4a24048f81afbe9fb62e7a6a49adbd1faf41f266b5f9feecdceb567aec096784/detection)

# Detection & Prevention

In order to detect the abuse of the `ms-msdt` scheme, a quick win would be to monitor for Office Applications spawning the "msdt.exe" program. A Defender for Endpoint query has already been created by [Kevin Beaumont](https://github.com/GossiTheDog/ThreatHunting/blob/master/AdvancedHuntingQueries/Follina-Office.ahq).

```
DeviceProcessEvents
| where ProcessCommandLine contains "msdt.exe"| where InitiatingProcessFileName has_any (@"WINWORD.EXE", @"EXCEL.EXE", @"OUTLOOK.EXE")
```
